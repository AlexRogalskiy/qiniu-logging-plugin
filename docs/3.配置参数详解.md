# 配置参数详解

在 log4j，log4j2 和 logback 的模版配置文件里面，我们给出了将数据打到七牛日志平台的 appender 的配置。大家可以使用那个模版配置根据自己的需要来设置自己的 appender。这里，对 appender 目前支持的每个参数，以及参数的默认值给出详细的讲解，以帮助大家合理地设置它们。

在 appender 支持的参数中，主要分为必填参数和可选参数，对于可选参数，它们在程序中都有默认的值，你可以不用指定它们。当然有的时候，默认的值并不适合你的场景，这种情况下，你可以在详细了解该可选参数含义的情况下，自行设置。

## 必填参数

|参数名|描述|
|---|---|
|workflowName|工作流的名称|
|workflowDesc|工作流的描述|
|pipelineRepo|消息队列的名称|
|logdbRepo|日志分析数据仓库的名称|
|accessKey|账号的 AccessKey|
|secretKey|账号的 SecretKey|

**备注** 上面指定的 workflowName，pipelineRepo，logdbRepo 等如果不存在的话，Plugin会自动进行创建，一般设置的时候，也不需要你去创建，只要指定一个不存在的 workflowName，pipelineRepo，logdbRepo 即可

## 可选参数

可选参数主要有如下的几类，我们分开介绍。

## 多机房部署

|参数名|默认值|描述|
|---|---|---|
|workflowRegion|nb|工作流所在机房，这个值用来支持多机房部署的场景，默认就是nb，不需要改| 

### 日志刷新

|参数名|默认值|描述|
|---|---|---|
|autoFlushInterval|5|由于日志上传是一个网络IO的请求，所以我们为了提升性能，在程序内部是将日志累计到2MB左右的时候，触发一次真正的网络请求，提交数据。在某些情况下，客户的日志量很少，可能等很久也没有积累到2MB，或者是为了测试，简单写了几行日志。这种情况下，为了能让客户及时看到日志，我们会根据这个参数设置的时间间隔主动触发日志提交。这个值单位为秒，默认为5，即5秒的间隔。|

### 私有化支持

|参数名|默认值|描述|
|---|---|---|
|pipelineHost|https://pipeline.qiniuapi.com|这个值在公有云情况下，不需要设置。在私有云情况下，设置为部署工程师给的 PipelineHost 地址。|
|logdbHost|https://insight.qiniuapi.com|这个值在公有云情况下，不需要设置。在私有云情况下，设置为部署工程师给的 LogdbHost 地址。|

### 网络故障处理

在实际的生产环境中，客户端的网络环境或者是服务端的网络环境或者是这个中间的路径可以认为都是不靠谱的，随时可能出现闪断，或者是某些情况下网络大面积故障的情况，为了在这种情况下，尽可能不丢失应用的日志，我们设计了相关的方案，详细可以参考 [日志上报错误处理方案](../design/1.日志上报错误处理方案.md) 。

这个方案支持指定如下几个参数：

|参数名|默认值|描述|
|---|---|---|
|logCacheDir|系统的临时目录|如果希望这个方案真正能用，那么最好是找个磁盘容量充足的路径，而且这个路径必须存在可写入。默认的系统临时目录在服务器重启之后下面所有的文件都会丢失，需要注意！|
|logRotateInterval|600|这个值是写入的日志文件切换时间间隔，单位是秒，默认为600秒，即10分钟切换一个新的日志文件进行写入。|
|logRetryInterval|60|对发送失败缓存在本地的日志进行重试发送的时间间隔，单位是秒，默认60秒，即1分钟。|

**注意** 写入的日志文件的最大大小是2MB，如果超过了这个大小，也会自动切换到新的日志文件进行写入。另外，在重试发送成功之后，对应的日志文件会被自动删除以节约磁盘空间。

### 性能调整

目前我们的日志推送和日志重试都是后台利用线程池来进行异步处理的。另外整体的传输协议是基于 HTTP/HTTPS。所以为了适应不同场景的需求，程序中除了默认使用适合大多数场景的参数配置外，还将这些配置通过可选配置参数暴露出来，以供有经验的用户根据时间情况进行调整。

**日志推送**

|参数名|默认值|描述|
|---|---|---|
|logPushThreadPoolSize|20|日志推送的最大线程数量|
|logPushConnectTimeout|10|日志推送HTTP请求的建立连接的超时时间，单位秒|
|logPushReadTimeout|30|日志推送HTTP请求的响应读取超时时间，单位秒|
|logPushWriteTimeout|60|日志推送HTTP请求的数据发送超时时间，单位秒|

**日志重试**

|参数名|默认值|描述|
|---|---|---|
|logRetryThreadPoolSize|20|日志重试的最大线程数量|
|logRetryConnectTimeout|10|日志重试HTTP请求的建立连接的超时时间，单位秒|
|logRetryReadTimeout|30|日志重试HTTP请求的响应读取超时时间，单位秒|
|logRetryWriteTimeout|60|日志重试HTTP请求的数据发送超时时间，单位秒|

在日志推送中，我们使用了类似 `Executors.newCachedThreadPool` 方式的线程池，如果在某些时刻日志推送所需要的线程数量超过限制，程序中线程提交将失败，然后将这些数据写入到磁盘中，加入重试的列表。

在日志重试中，我们使用了 `Executors.newFixedThreadPool` 方式的线程池，来控制稳定的重试任务数量。