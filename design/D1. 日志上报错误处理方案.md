# 背景

该方案主要解决日志上报失败情况下的处理方式。日志上报失败可能是因为客户端网络故障，或者是服务端的网络故障，无论是哪种故障，我们都需要严谨地考虑如何避免日志丢失的问题。

# 方案

在日志上报失败的时候，可选的方案是进行多次重试，比如按照指数级延迟（1秒，2秒，4秒，8秒，16秒）重试多次。然后仍然失败的情况下，把日志写入本地文件，然后循环监测网络情况，在网络恢复的时候再进行发送。这种重试的策略在实际生产环境下，会严重影响整体的业务性能，所以我们这里不打算采用这种方案。

目前我们采用的方案是，如果日志上报失败，则把该日志内容写入到本地文件中，并且确保每个文件的大小不超过2MB，因为PIPELINE支持的最大POST BODY SIZE是2MB，这样我们在重试的时候就不需要在读取文件内容的时候再去判断大小，而是直接读取整个文件，直接发送。

我们会在后台单独维护一个线程池去发送这些失败的日志文件，在每个文件重试上传成功之后，即删除该文件，以节约磁盘空间。为了避免多线程同时向文件写和读，我们将读写的文件分开。我们将按照10分钟的间隔，来向tmp文件写入内容，如果这个十分钟内的日志超过了2MB，那么可以切换为如下的命名方式的文件：

```
2018_07_02_16_00_00000.log.tmp
2018_07_02_16_00_00001.log.tmp
...
```

如果在下一个十分钟，那么我们将把写的文件切换为：

```
2018_07_02_16_10_00000.log.tmp
2018_07_02_16_10_00001.log.tmp
...
```

我们在后台单独维护一个线程池，这个线程池的主要工作有两个：
（1）将以 .log.tmp 结尾的文件转换为 .log 结尾
（2）然后将以 .log 结尾的所有文件进行上传，上传成果之后删除该文件，否则仍然保留，在下一个重试周期重试。

## 实施

该方面需要抽象出两个参数，用来自定义配置文件：

```
logCacheDir 错误日志临时写入目录，最好不要设置为 /tmp ，否则重启即没有了，如果不设置，默认会在应用程序的运行目录自动创建一个。
logRotateInterval=10 // 默认为10分钟
logRetryInterval=1 重试的时间间隔，单位为分钟，默认为1分钟。
```

**日志写入**

日志写入需要注意日志的切换，切换有两个条件，满足任意一个即切换：

（1）日志文件接近2MB（在每次写入之前，检查下是否会超过2MB，如果会超过则切换）
（2）切换周期达到logRotate所要求的间隔。

**日志转换**

日志从 .log.tmp 转换为 .log 文件在以下两种情况下触发：

（1）日志文件在切换到新文件的时候，顺便把旧的日志文件从 .log.tmp 切换为 .log
（2）后台重试上传的线程在每次上传之前，获取 .log.tmp 文件列表，然后将所有时间已过期（在当前时间减去logRotate之前）的时候，切换为 .log

**日志读取（重试）**

（1）读取所有以 .log 结尾的文件，然后进行上传，如果上传成功即删除这个文件，如果失败，等待下次重试。