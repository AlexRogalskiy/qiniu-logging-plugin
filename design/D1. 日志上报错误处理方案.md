# 背景

该方案主要解决日志上报失败情况下的处理方式。日志上报失败可能是因为客户端网络故障，或者是服务端的网络故障，无论是哪种故障，我们都需要严谨地考虑如何避免日志丢失的问题。

# 方案

在日志上报失败的时候，可选的方案是进行多次重试，比如按照指数级延迟（1秒，2秒，4秒，8秒，16秒）重试多次。然后仍然失败的情况下，把日志写入本地文件，然后循环监测网络情况，在网络恢复的时候再进行发送。这种重试的策略在实际生产环境下，会严重影响整体的业务性能，所以我们这里不打算采用这种方案。

目前我们采用的方案是，如果日志上报失败，则把该日志内容写入到本地文件中，并且确保每个文件的大小不超过2MB，因为PIPELINE支持的最大POST BODY SIZE是2MB，这样我们在重试的时候就不需要在读取文件内容的时候再去判断大小，而是直接读取整个文件，直接发送。

我们会在后台单独维护一个线程池去发送这些失败的日志文件，在每个文件重试上传成功之后，即删除该文件，以节约磁盘空间。为了避免多线程同时向文件写和读，我们将读写的文件分开。我们将按照10分钟的间隔，来向tmp文件写入内容，如果这个十分钟内的日志超过了2MB，那么可以切换为如下的命名方式的文件：

```
2018_07_02_16_00_00000.log.tmp
2018_07_02_16_00_00001.log.tmp
...
```

如果在下一个十分钟，那么我们将把写的文件切换为：

```
2018_07_02_16_10_00000.log.tmp
2018_07_02_16_10_00001.log.tmp
...
```

我们在后台单独维护一个线程池，这个线程池的主要工作有两个：
（1）将以 .log.tmp 结尾的文件转换为 .log 结尾
（2）然后将以 .log 结尾的所有文件进行上传，上传成果之后删除该文件，否则仍然保留，在下一个重试周期重试。